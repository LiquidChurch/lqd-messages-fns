define(["./core","./var/slice","./callbacks"],function(c,d){function a(f){return f}function e(f){throw f}function b(h,g,f){var i;try{if(h&&c.isFunction((i=h.promise))){i.call(h).done(g).fail(f)}else{if(h&&c.isFunction((i=h.then))){i.call(h,g,f)}else{g.call(undefined,h)}}}catch(h){f.call(undefined,h)}}c.extend({Deferred:function(h){var g=[["notify","progress",c.Callbacks("memory"),c.Callbacks("memory"),2],["resolve","done",c.Callbacks("once memory"),c.Callbacks("once memory"),0,"resolved"],["reject","fail",c.Callbacks("once memory"),c.Callbacks("once memory"),1,"rejected"]],i="pending",j={state:function(){return i},always:function(){f.done(arguments).fail(arguments);return this},"catch":function(k){return j.then(null,k)},pipe:function(){var k=arguments;return c.Deferred(function(l){c.each(g,function(n,m){var o=c.isFunction(k[m[4]])&&k[m[4]];f[m[1]](function(){var p=o&&o.apply(this,arguments);if(p&&c.isFunction(p.promise)){p.promise().progress(l.notify).done(l.resolve).fail(l.reject)}else{l[m[0]+"With"](this,o?[p]:arguments)}})});k=null}).promise()},then:function(n,k,m){var o=0;function l(s,p,r,q){return function(){var u=this,t=arguments,v=function(){var x,y;if(s<o){return}x=r.apply(u,t);if(x===p.promise()){throw new TypeError("Thenable self-resolution")}y=x&&(typeof x==="object"||typeof x==="function")&&x.then;if(c.isFunction(y)){if(q){y.call(x,l(o,p,a,q),l(o,p,e,q))}else{o++;y.call(x,l(o,p,a,q),l(o,p,e,q),l(o,p,a,p.notifyWith))}}else{if(r!==a){u=undefined;t=[x]}(q||p.resolveWith)(u,t)}},w=q?v:function(){try{v()}catch(x){if(c.Deferred.exceptionHook){c.Deferred.exceptionHook(x,w.stackTrace)}if(s+1>=o){if(r!==e){u=undefined;t=[x]}p.rejectWith(u,t)}}};if(s){w()}else{if(c.Deferred.getStackHook){w.stackTrace=c.Deferred.getStackHook()}window.setTimeout(w)}}}return c.Deferred(function(p){g[0][3].add(l(0,p,c.isFunction(m)?m:a,p.notifyWith));g[1][3].add(l(0,p,c.isFunction(n)?n:a));g[2][3].add(l(0,p,c.isFunction(k)?k:e))}).promise()},promise:function(k){return k!=null?c.extend(k,j):j}},f={};c.each(g,function(l,k){var n=k[2],m=k[5];j[k[1]]=n.add;if(m){n.add(function(){i=m},g[3-l][2].disable,g[0][2].lock)}n.add(k[3].fire);f[k[0]]=function(){f[k[0]+"With"](this===f?undefined:this,arguments);return this};f[k[0]+"With"]=n.fireWith});j.promise(f);if(h){h.call(f,f)}return f},when:function(g){var k=arguments.length,h=k,j=Array(h),m=d.call(arguments),l=c.Deferred(),f=function(n){return function(i){j[n]=this;m[n]=arguments.length>1?d.call(arguments):i;if(!(--k)){l.resolveWith(j,m)}}};if(k<=1){b(g,l.done(f(h)).resolve,l.reject);if(l.state()==="pending"||c.isFunction(m[h]&&m[h].then)){return l.then()}}while(h--){b(m[h],f(h),l.reject)}return l.promise()}});return c});